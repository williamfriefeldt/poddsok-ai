<!DOCTYPE html>
<html>
  <head>
    <link rel="shortcut icon" type="image/x-icon" href="static/images/title-icon.png" />
    <title>Plyssningen v0.1</title>
    {{ moment.include_jquery() }}
    {{ moment.include_moment() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
  	<div class="flex">
      <div class="col-left">
        <header>
          <img src="static/images/title-icon.png" />
          <h1> Plyssningen v0.1 </h1>
        </header>
        <span id="record-status"></span> 
        <button id="record-btn"> Spela in </button>
        <div id="allResults"> </div>
      </div>
    	<div class="col-right">
    		{{ moment().format('MMMM Do YYYY, h:mm:ss a') }}
    		<h3> Podcast: {{ data.podcast.replace("_"," ") }} </h3>
    		<h3> Avsnitt: {{ data.episode.replace("_"," ") }} </h3>
    		<h3> Tid: <span id="time"> 00:00 </span></h3>
    		<a href="{{ url_for('download', filename=data.podcast+'_-_'+data.episode) }}" target="_blank">
          <button> Ladda ner textfil </button>
        </a>
    	</div>
		</div>
  </body>

  <script>
    
    $('h1').css( { opacity:1 });
    var btn = $( '#record-btn' );

  	$( '#record-btn' ).click( () => {
  		if( btn.html() === 'Spela in' ) { 
        btn.html( 'Pause' );
        timer();
  		} else {
        btn.html( 'Avslutar...' );
      }
	  });

	  var timer = () => {
      if( btn.html() === 'Pause' ) {
    		$.getJSON( '/time', data => {
          $( '#record-status' ).html( data.recordStatus );
          checkResult(); 
        });
      } else {
        btn.html( 'Spela in' );
      }
	  };

    var checkResult = () => {
      $.getJSON( '/checkResult', data => {
        $( '#time' ).html( data.time );
        if( !data.isListening ) {
          if( data.recordRes === "Tillåtelse till tangentbord nekat, vänligen tillåt detta." ) {
            $( '#record-status' ).html( data.recordRes );
          } else {
            $( '#record-status' ).html( 'Resultat: "' + data.recordRes +'"' );
            saveResult();
          }
          $( '#record-btn' ).css('visibility', 'visible');
        } else if( data.recordRes === 'Analyserar ljud...' ) {
          $('#record-status').html( data.recordRes );
          setTimeout( () => { checkResult() }, 1000 );
        } else {
          setTimeout( () => { checkResult() }, 1000 );
        }
      });
    };

    var saveResult = () => {
      $.getJSON( '/saveResult', data => {
        var html = '';
        for( var i in data ){
          html += '<div class="flex"><div class="col-1">' + data[i].time + '</div><div class="col-2">' + data[i].text + '</div></div>';
        }
        var div = $( '#allResults' );
        div.html( html );
        div.scrollTop( $( '#allResults' )[0].scrollHeight );
        timer();
      });
    };
  	
  </script>
</html>
